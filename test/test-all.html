<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG Studio æµ‹è¯•è¿è¡Œå™¨</title>
    <link rel="stylesheet" href="../src/css/main.css">
    <link rel="stylesheet" href="../src/css/theme.css">
    <link rel="stylesheet" href="../src/css/color-picker.css">
    <link rel="stylesheet" href="../src/css/crop-batch-export.css">
    <link rel="stylesheet" href="../src/css/export-dialog.css">
    <link rel="stylesheet" href="../src/css/measure-tool.css">
    <link rel="stylesheet" href="../src/css/opacity-controls.css">
    <link rel="stylesheet" href="../src/css/ruler-grid.css">
    <link rel="stylesheet" href="../src/css/shortcuts.css">
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        
        .test-panel {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .test-controls {
            margin-bottom: 15px;
        }
        
        button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        #test-output {
            background-color: #000;
            color: #0f0;
            font-family: monospace;
            padding: 15px;
            border-radius: 5px;
            height: 400px;
            overflow-y: auto;
        }
        
        .test-info {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="test-panel">
        <h1>SVG Studio æµ‹è¯•è¿è¡Œå™¨</h1>
        
        <div class="test-info">
            <p>æ­¤é¡µé¢ç”¨äºè¿è¡Œ SVG Studio çš„æ‰€æœ‰æµ‹è¯•ï¼ŒéªŒè¯åŠŸèƒ½å®Œæ•´æ€§å’Œåˆç†æ€§ã€‚</p>
        </div>
        
        <div class="test-controls">
            <button id="run-all-btn">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button id="run-layer-btn">æµ‹è¯•å›¾å±‚ç®¡ç†</button>
            <button id="run-property-btn">æµ‹è¯•å±æ€§é¢æ¿</button>
            <button id="run-tool-btn">æµ‹è¯•å·¥å…·å†²çª</button>
            <button id="run-export-btn">æµ‹è¯•å¯¼å‡ºåŠŸèƒ½</button>
        </div>
        
        <div id="test-output">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
    </div>
    
    <!-- åº”ç”¨ç¨‹åº UI å…ƒç´ ï¼ˆç”¨äºæµ‹è¯•ï¼‰ -->
    <div style="display: none;">
        <!-- å›¾å±‚é¢æ¿ -->
        <div id="layers-panel">
            <div id="layers-list"></div>
        </div>
        
        <!-- å±æ€§é¢æ¿ -->
        <div id="property-panel">
            <div class="property-section">
                <div class="color-property-container">
                    <label for="fill-color">å¡«å……:</label>
                    <input type="color" id="fill-color" value="#000000">
                </div>
                <div class="opacity-slider-container">
                    <label for="fill-opacity">ä¸é€æ˜åº¦:</label>
                    <input type="range" id="fill-opacity" min="0" max="1" step="0.01" value="1">
                    <span id="fill-opacity-value">100%</span>
                </div>
                
                <div class="color-property-container">
                    <label for="stroke-color">æè¾¹:</label>
                    <input type="color" id="stroke-color" value="#000000">
                </div>
                <div class="opacity-slider-container">
                    <label for="stroke-opacity">ä¸é€æ˜åº¦:</label>
                    <input type="range" id="stroke-opacity" min="0" max="1" step="0.01" value="1">
                    <span id="stroke-opacity-value">100%</span>
                </div>
            </div>
        </div>
        
        <!-- æµ‹é‡å·¥å…· -->
        <div id="measure-tool-panel">
            <button id="measure-tool-btn">æµ‹é‡å·¥å…·</button>
        </div>
        
        <!-- è£å‰ªå·¥å…· -->
        <div id="crop-tool-panel">
            <button id="crop-tool-btn">è£å‰ªå·¥å…·</button>
        </div>
        
        <!-- å¯¼å‡ºæŒ‰é’® -->
        <button id="export-btn">å¯¼å‡º</button>
        <div id="export-dropdown">
            <div class="export-format-btn" data-format="svg">SVG</div>
            <div class="export-format-btn" data-format="png">PNG</div>
            <div class="export-format-btn" data-format="jpeg">JPEG</div>
            <div class="export-format-btn" data-format="webp">WebP</div>
            <div class="export-format-btn" data-format="pdf">PDF</div>
            
            <div class="export-options">
                <label for="export-scale">ç¼©æ”¾æ¯”ä¾‹:</label>
                <input type="range" id="export-scale" min="0.5" max="5" value="1" step="0.1">
                <span id="export-scale-value">1.0x</span>
                
                <label for="export-bg-color">èƒŒæ™¯é¢œè‰²:</label>
                <input type="color" id="export-bg-color" value="#ffffff">
                
                <label for="export-transparent">é€æ˜èƒŒæ™¯:</label>
                <input type="checkbox" id="export-transparent">
            </div>
        </div>
        
        <!-- å¯¼å‡ºå¯¹è¯æ¡† -->
        <div id="export-dialog" class="export-dialog">
            <div class="export-dialog-content">
                <div class="export-dialog-header">
                    <h3>å¯¼å‡º SVG</h3>
                    <button class="export-dialog-close">&times;</button>
                </div>
                <div class="export-dialog-body">
                    <div class="export-formats">
                        <div class="export-format-btn selected" data-format="svg">
                            <i class="fas fa-code"></i>
                            <span>SVG</span>
                        </div>
                        <div class="export-format-btn" data-format="png">
                            <i class="fas fa-image"></i>
                            <span>PNG</span>
                        </div>
                        <div class="export-format-btn" data-format="jpeg">
                            <i class="fas fa-file-image"></i>
                            <span>JPEG</span>
                        </div>
                        <div class="export-format-btn" data-format="webp">
                            <i class="fas fa-photo-video"></i>
                            <span>WebP</span>
                        </div>
                        <div class="export-format-btn" data-format="pdf">
                            <i class="fas fa-file-pdf"></i>
                            <span>PDF</span>
                        </div>
                    </div>
                    
                    <div class="export-options-group">
                        <h4>å¯¼å‡ºé€‰é¡¹</h4>
                        <div class="export-option">
                            <label for="export-scale-new">ç¼©æ”¾æ¯”ä¾‹:</label>
                            <input type="range" id="export-scale-new" min="0.5" max="5" value="1" step="0.1">
                            <span id="export-scale-value-new" class="export-option-value">1.0x</span>
                        </div>
                        <div class="export-option">
                            <label for="export-bg-color-new">èƒŒæ™¯é¢œè‰²:</label>
                            <input type="color" id="export-bg-color-new" value="#ffffff">
                            <div class="spacer" style="flex-grow: 1;"></div>
                        </div>
                        <div class="export-option">
                            <label for="export-transparent-new">é€æ˜èƒŒæ™¯:</label>
                            <input type="checkbox" id="export-transparent-new">
                            <div class="spacer" style="flex-grow: 1;"></div>
                        </div>
                    </div>
                    
                    <div class="export-options-group image-format-options">
                        <h4>å›¾åƒè´¨é‡</h4>
                        <div class="export-option">
                            <label for="export-quality">è´¨é‡:</label>
                            <input type="range" id="export-quality" min="0.1" max="1.0" value="0.9" step="0.1">
                            <span id="export-quality-value" class="export-option-value">90%</span>
                        </div>
                    </div>
                </div>
                <div class="export-dialog-footer">
                    <button class="cancel-btn">å–æ¶ˆ</button>
                    <button class="export-btn">å¯¼å‡º</button>
                </div>
            </div>
        </div>
        
        <!-- SVG ç”»å¸ƒ -->
        <div id="svg-canvas">
            <svg width="800" height="600" viewBox="0 0 800 600"></svg>
        </div>
        
        <!-- åŠ è½½æç¤º -->
        <div id="loading-overlay" class="loading-overlay hidden">
            <div class="spinner"></div>
            <p id="loading-message">å¤„ç†ä¸­...</p>
        </div>
    </div>
    
    <!-- å¯¼å…¥æµ‹è¯•è„šæœ¬ -->
    <script type="module">
        // ç”¨äºæ•è·å’Œæ˜¾ç¤ºæµ‹è¯•è¾“å‡º
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const testOutput = document.getElementById('test-output');
        
        // é‡å®šå‘æ§åˆ¶å°è¾“å‡ºåˆ°æµ‹è¯•è¾“å‡ºé¢æ¿
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
            const logElement = document.createElement('div');
            logElement.textContent = message;
            testOutput.appendChild(logElement);
            testOutput.scrollTop = testOutput.scrollHeight;
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
            const logElement = document.createElement('div');
            logElement.textContent = 'âŒ ' + message;
            logElement.style.color = '#ff5555';
            testOutput.appendChild(logElement);
            testOutput.scrollTop = testOutput.scrollHeight;
        };
        
        // åˆ›å»ºæ¨¡æ‹Ÿåº”ç”¨ç¨‹åºç¯å¢ƒ
        import { EventBus } from '../src/js/utils/event-bus.js';
        import { LayerManager } from '../src/js/modules/layer-manager.js';
        import { ElementSelector } from '../src/js/modules/element-selector.js';
        import { MeasureTool } from '../src/js/modules/measure-tool.js';
        import { CropManager } from '../src/js/modules/crop-manager.js';
        import { ExportManager } from '../src/js/modules/export-manager.js';
        
        // åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„åº”ç”¨ç¨‹åºç¯å¢ƒ
        window.createMockApp = async () => {
            const eventBus = new EventBus();
            
            // åˆ›å»ºåº”ç”¨ç¨‹åºå¯¹è±¡
            window.app = {
                eventBus: eventBus,
                elementSelector: new ElementSelector(eventBus),
                layerManager: new LayerManager(eventBus),
                measureTool: new MeasureTool(eventBus),
                cropManager: new CropManager(eventBus),
                exportManager: new ExportManager(eventBus)
            };
            
            // åˆå§‹åŒ–ç»„ä»¶
            window.app.elementSelector.init();
            window.app.layerManager.init();
            window.app.measureTool.init();
            window.app.cropManager.init();
            window.app.exportManager.init();
            
            console.log('ğŸ”§ æ¨¡æ‹Ÿåº”ç”¨ç¨‹åºç¯å¢ƒåˆ›å»ºå®Œæˆ');
            return window.app;
        };
        
        // å¯¼å…¥æµ‹è¯•æ¨¡å—
        import { runTests } from './test-suite.js';
        import { testLayerOperations } from './modules/test-layer-operations.js';
        import { testPropertyPanelLayout } from './modules/test-property-panel-layout.js';
        import { testToolConflicts } from './modules/test-tool-conflicts.js';
        import { testExportDialog } from './modules/test-export-dialog.js';
        
        // åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
        async function initTestEnvironment() {
            await window.createMockApp();
            console.log('ğŸ”§ æµ‹è¯•ç¯å¢ƒå‡†å¤‡å°±ç»ª');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
        document.addEventListener('DOMContentLoaded', () => {
            initTestEnvironment();
        });
        
        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        document.getElementById('run-all-btn').addEventListener('click', async () => {
            testOutput.innerHTML = 'å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...\n';
            try {
                await testLayerOperations();
                await testPropertyPanelLayout();
                await testToolConflicts();
                await testExportDialog();
                console.log('âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆï¼');
            } catch (error) {
                console.error('âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
            }
        });
        
        // è¿è¡Œå›¾å±‚ç®¡ç†æµ‹è¯•
        document.getElementById('run-layer-btn').addEventListener('click', async () => {
            testOutput.innerHTML = 'å¼€å§‹è¿è¡Œå›¾å±‚ç®¡ç†æµ‹è¯•...\n';
            try {
                await testLayerOperations();
            } catch (error) {
                console.error('âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
            }
        });
        
        // è¿è¡Œå±æ€§é¢æ¿æµ‹è¯•
        document.getElementById('run-property-btn').addEventListener('click', async () => {
            testOutput.innerHTML = 'å¼€å§‹è¿è¡Œå±æ€§é¢æ¿æµ‹è¯•...\n';
            try {
                await testPropertyPanelLayout();
            } catch (error) {
                console.error('âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
            }
        });
        
        // è¿è¡Œå·¥å…·å†²çªæµ‹è¯•
        document.getElementById('run-tool-btn').addEventListener('click', async () => {
            testOutput.innerHTML = 'å¼€å§‹è¿è¡Œå·¥å…·å†²çªæµ‹è¯•...\n';
            try {
                await testToolConflicts();
            } catch (error) {
                console.error('âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
            }
        });
        
        // è¿è¡Œå¯¼å‡ºåŠŸèƒ½æµ‹è¯•
        document.getElementById('run-export-btn').addEventListener('click', async () => {
            testOutput.innerHTML = 'å¼€å§‹è¿è¡Œå¯¼å‡ºåŠŸèƒ½æµ‹è¯•...\n';
            try {
                await testExportDialog();
            } catch (error) {
                console.error('âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
            }
        });
    </script>
</body>
</html>
